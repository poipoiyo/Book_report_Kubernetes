# 第四章 Pipeline 系統介紹

### 4.1 Pipeline 思路選擇

思考方向：該如何部署，特色功能有哪些，付費與否帶來的差異性



#### 4.1.1 部署方式

自架服務，優點：

1. 如果用開源專案，有機會透過修改程式碼來滿足客製化需求
2. 使用彈性，擴展性佳，較容易修正
3. 避免過度依賴廠商，轉移問題也較少

缺點：

1. 要自己維護Pipeline系統的儲存硬碟、網路效能
2. 第三方整合不一定，需要自己研究和處理
3. 出問題不一定有專業團隊能問，團隊內要有工程人員專門維護

其他議題：

1. 安全性不一定比較好，取決於自架環境是內部機房還是雲端環境
2. 成本不一定少，底層的設備也都要花錢



SaaS，優點：

1. 不需要擔心底層基礎建設，服務業者都會提供
2. 有相關FAQ和管道諮詢
3. 第三方服務整合性高
4. 有使用付費版本，成本更容易運算

缺點：

1. 功能受限於SaaS服務者，部分功能可以花錢升級，部分則是平台限制
2. 功能不一定能自我擴充
3. 容易過度依賴廠商
4. 服務可用性無法自行掌握，有問題只能等廠商

其他議題：

1. 效能不一定比較差，完全依據團隊的使用方式



#### 4.1.2 特色探討

常見且需求最廣的特性：

1. 通知系統：工作成功或失敗時，是否有方式通知到外部
2. 專案管理：團隊可以透過系統同時滿足管理和為運的需求，或是整合知名平台，補足功能
3. 使用者管理：是否可以和常用的系統整合，像是LDAP/ Windows AD/ Google Suite/ Crowd/ OpenID
4. Pipeline as a Code：透過程式碼而非UI來定義Pipeline上的設定
5. 操作方式：對於非工程人員，有一個一目瞭然的UI是很重要的特色
6. 文件完整性：使用上是否可以找到詳細的說明文件，同時文件的更新程度是否頻繁
7. 除錯性：發生問題時如何除錯，是否有諮詢管道
8. 機密資訊管理：是否提供管理機密資訊的能力
9. 雲端整合度：是否能和雲端服務整合
10. 支援作業系統：除了Linux是否有支援其他作業系統



#### 4.1.3 付費功能探討

限制的功能：

1. 同時間可以有多少個並行的工作
2. 工作運行時間的限制
3. 工作的Timeout上限：每個工作最多可以等多久
4. 支援的平台和類型



### 4.2 CI Pipeline 與 Kubernetes

#### 架構

透過CI概念來整合時，要如何存取Kubernetes？

1. 遠方環境架設一個固定的叢集，Pipeline執行過程中去存取該叢集來使用
2. Pipeline執行過程中，動態產生一個全新的叢集供CI使用



#### 遠方固定Kubernetes叢集

Pipeline的CI過程中會需要和叢集連接，當程式碼改變時，會觸發工作流程的運作。

舉例：工作流程第一步是初始化，接著進行簡單的測試，為了將應用程式榮企劃，本地透過Dockerfile來建置Container Image，接著推向遠方的Container Registry，最後告知從集使用剛建置好的Container Image。

潛在問題：

1. 良好的測試要確保環境不被汙染，沒有測試產物遺留在環境中
2. 如果該Pipeline同時支援多個工作，會不會同時觸發多個測試，有沒有可能會有不預期的測試結果
3. Image推到遠方的Registry後，如果測試失敗，Image該保留還是刪除
4. 為了存取，需要準備一份足夠全縣的KUBECONFIG檔案到CI的工作流程中，如果檔案不慎流出，取的人也能夠存取。

優勢：只要專注處理如何測試即可，不在乎工作在哪裏運作寧購透，只要能夠透過kubectl/ helm指令存取遠方叢集即可



#### Pipeline 動態架設Kubernetes叢集

前半部工作相同，建置完Image後不需要立刻推向遠方。隨後是在本地建置叢集進行測試，因為動態架設Pipeline，有機會直接使用前述步驟所產生的Container Image，省下網路存取的延遲，通過測試後，將該Image推向遠方去更新。

優點：

1. Kubernetes獨立生成，多個工作並行，每個環境都有獨立的Kubernetes，資源不共享也不會衝突
2. 使用的KUBECONFIG都會隨著工作結束而無效且銷毀，少了安全隱憂
3. Image要通過測試才會推向遠方

缺點：

1. 測試失敗時，不容易保存當前日誌與環境，除錯困難
2. 如果測試會需要前置準備，會須多額外服務，不一定好準備
3. 要思考如何方便的架設Kubernetes，在虛擬機器上困難度更高



### 4.3 以Github Action示範整合Kubernetes於Pipeline系統中



### 4.4 Kubernetes 應用程式測試

測試可以分成兩個層面：

1. YAML檔案的測試
2. 應用程式功能測試



YAML檔案測試的三個面向：

1. YAML格式是否合法，不考慮所有數值與內容是否有意義，單純針對語法。
2. YAML內容的數值是否有意義，需要針對使用情境。也需要知道一種測試可以去檢查當眠的YAML是否符合Kubernetes規範
3. YAML內容的數值是否符合團隊規範
4. 除了YAML，也流行用Helm包裝應用程式要如何測試Helm的安裝



#### 4.4.1 YAML 測試

Yamillint：針對YAML格式的linter，不單只檢查格式是否合法，還會檢查小錯誤

Kubeval：專門用來處理Kubernetes資源的工具，支援YAML和JSON，背後透過Kubernetes OpenAI的規格來幫你確認是否合乎規範

Conftest：前兩套工具整合，可以針對YAML進行語法和語意的測試，YAML也要符合團隊內容\



#### 4.4.2 Helm 測試

探討方向：Helm Chart本身內容是否正確、Helm Chart搭配values安裝的YAML檔案是否正確

先渲染出最後的YAML檔案，就可以用前面提到的工具測試



除了template以外，也有提供lint指令來幫忙檢查一些本身設定和values.yaml內容是否符合需求。購過helm lint來檢查，需要先準備好規範，像是image.pullPolicy必須設定、image.PullPolicy必須是個字串，且必須設定成Always



### 4.5 CI PipeLine 與 Kubernetes 結論

應用程式和應用程式的YAML是否要放在同一個Git專案中：

1. 放在一起的架構下，整個CI Pipeline過程就會需要針對應用程式和YAML檔案。對於開發者來說，有任何更動都可以同時修相關YAML檔案，同時修改帶來的缺點就是Git紀錄會和YAML的修改混在一起。
2. 如果分開放，彼此的CI Pipeline流程會完全不同，工作會需要更詳細的規範，當應用程式修改後並且產生相關的Image後，會需要針對YAML放置的Git專案產生新的修改，告知其使用新的Image



